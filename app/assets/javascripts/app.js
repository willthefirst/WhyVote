// Generated by CoffeeScript 1.3.3
(function() {
  var HomeController;

  Array.prototype.merge = function(other) {
    return Array.prototype.push.apply(this, other);
  };

  HomeController = function($scope, $window, $location, $http) {
    $scope.select_candidate = function(candidate) {
      $scope.candidate = candidate;
      angular.element('.candidate').removeClass('selected');
      angular.element('#' + candidate).addClass('selected');
      angular.element('.candidate').hide();
      return angular.element('.selected').show();
    };
    $scope.submit = function() {
      return $http({
        method: 'POST',
        url: '/posts',
        data: $.param({
          post: {
            reason: this.reason,
            candidate: this.candidate
          },
          user: {
            fingerprint: jQuery.fingerprint(),
            email: this.email
          }
        }),
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        }
      }).success(function(rsp, status, headers) {
        if (rsp.success) {
          angular.element('section#submit').fadeOut();
          rsp.post.votes = 1;
          return $scope.posts.unshift(rsp.post);
        }
      });
    };
    $scope.vote = function(post) {
      return $http.post('/vote', {
        post: post,
        fingerprint: jQuery.fingerprint()
      }).success(function(rsp) {
        var num, votes;
        if (rsp.success) {
          votes = angular.element('#post' + post.id).find('.votes');
          num = parseInt(votes.attr('orig')) + 1;
          return votes.html(num);
        }
      });
    };
    return $http.get('/posts.json?fingerprint=' + jQuery.fingerprint()).success(function(rsp) {
      _.each(rsp, function(post) {
        return post.votes = _.filter(post.votes, function(vote) {
          return vote.positive;
        }).length;
      });
      return $scope.posts = rsp;
    });
  };

  angular.module('why-vote', ['ngCookies']).directive('vote', function() {
    return function(scope, element, attrs) {
      var votes;
      votes = element.find('.votes');
      return element.on({
        mouseenter: function() {
          votes.attr('orig', votes.html());
          return votes.html('<--');
        },
        mouseleave: function() {
          if (votes.html() === '&lt;--') {
            return votes.html(votes.attr('orig'));
          }
        }
      });
    };
  }).config([
    '$routeProvider', '$locationProvider', '$httpProvider', function($routeProvider, $locationProvider, $httpProvider) {
      $routeProvider.when('/', {
        templateUrl: '/partials/home.html',
        controller: HomeController
      }).otherwise({
        redirectTo: '/'
      });
      return $locationProvider.html5Mode(true);
    }
  ]);

}).call(this);
